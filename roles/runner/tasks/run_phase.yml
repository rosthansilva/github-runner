- name: "Executar fase {{ phase_name }}"
  block:

    # 1️⃣ Perguntar confirmação
    - name: Confirmar execução do item (se necessário)
      ansible.builtin.pause:
        prompt: "{{ item.confirmation_message }}"
      register: user_input
      loop: "{{ pre_run_items }}"
      when: item.ask_confirmation | default(false)
      loop_control:
        label: "{{ item.name }}"
    
    # 2️⃣ Validar confirmação do usuário
    - name: Validar confirmação do usuário
      ansible.builtin.fail:
        msg: "Execução interrompida pelo usuário no item {{ item.item.name }}. Apenas 'yes' permite continuar."
      loop: "{{ user_input.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name }}"
      when: item.user_input | lower != 'yes'
    
    # 3️⃣ Executar o comando/script
    - name: Executar comando/script
      vars:
        cmd_to_run: >-
          {% if item.type | lower in ['bash','sh','python','powershell'] %}
            {{ item.type | lower }} {{ item.path | default('') }}
          {% elif item.type | lower == 'command' %}
            {{ item.cmd | default('') }}
          {% else %}
            echo "Tipo de item desconhecido"
          {% endif %}
      ansible.builtin.shell: "{{ cmd_to_run }}"
      args:
        chdir: "{{ playbook_dir }}"
      register: cmd_result
      ignore_errors: true
      loop: "{{ phase_items | default([]) }}"
      loop_control:
        label: "{{ item.name }}"

    # 4️⃣ Mostrar saída do item em estilo terraform plan
    - name: Mostrar saída do item
      ansible.builtin.debug:
        msg: |
          ┌─[ {{ item.name | default('N/A') }} | {{ item.type | default('N/A') }} ]─────────────────────────────
          │ Comando/Script: {{ item.path | default(item.cmd | default('N/A')) }}
          │ Return Code  : {{ cmd_result.rc | default('N/A') }}
          ├─ STDOUT ──────────────────────────────────────────────────────────────
          {{ cmd_result.stdout | default('') | indent(2) }}
          ├─ STDERR ──────────────────────────────────────────────────────────────
          {{ cmd_result.stderr | default('') | indent(2) }}
          └───────────────────────────────────────────────────────────────────────
      loop: "{{ phase_items | default([]) }}"
      loop_control:
        label: "{{ item.name }}"
