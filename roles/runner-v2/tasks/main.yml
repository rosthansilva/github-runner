---
- name: Garantir diretÃ³rio temporÃ¡rio
  ansible.builtin.file:
    path: "{{ runner_config.tmp_dir }}"
    state: directory
    mode: '0755'

# ğŸ”¹ PrÃ©-verificaÃ§Ã£o PowerShell
- name: Verificar se hÃ¡ itens PowerShell a executar
  ansible.builtin.set_fact:
    need_powershell: >-
      {{ pre_run | selectattr('type','equalto','powershell') | list | length > 0
         or run_action | selectattr('type','equalto','powershell') | list | length > 0
         or post_run | selectattr('type','equalto','powershell') | list | length > 0 }}

- name: Checar se PowerShell estÃ¡ instalado
  ansible.builtin.command: "which pwsh"
  register: pwsh_check
  ignore_errors: yes
  when: need_powershell

- name: Instalar PowerShell no Ubuntu se necessÃ¡rio
  ansible.builtin.shell: |
    sudo snap install powershell --channel=lts/stable --classic
  when:
    - need_powershell
    - pwsh_check.rc != 0
    - ansible_facts['os_family'] == 'Debian'

- name: Informar instalaÃ§Ã£o do PowerShell
  ansible.builtin.debug:
    msg: "PowerShell instalado ou jÃ¡ disponÃ­vel."
  when: need_powershell

# ğŸ”¹ Rodar fases
- name: Executar Pre-run ğŸš€
  include_tasks: run_phase.yml
  vars:
    phase_name: "Pre-run"
    phase_items: "{{ pre_run }}"

- name: Executar Run Action ğŸƒ
  include_tasks: run_phase.yml
  vars:
    phase_name: "Run Action"
    phase_items: "{{ run_action }}"

- name: Executar Post-run ğŸ› ï¸
  include_tasks: run_phase.yml
  vars:
    phase_name: "Post-run"
    phase_items: "{{ post_run }}"
